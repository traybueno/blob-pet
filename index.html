<!DOCTYPE html>
<html>
<head>
  <title>Blob Pet - Watchtower Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #0a0a0a; 
      color: #fafafa;
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      max-width: 400px;
      width: 100%;
    }
    
    header {
      text-align: center;
      margin-bottom: 24px;
    }
    header h1 {
      font-size: 28px;
      margin-bottom: 4px;
    }
    header .subtitle {
      color: #71717a;
      font-size: 14px;
    }
    
    /* Pet Display */
    .pet-area {
      background: #18181b;
      border: 2px solid #27272a;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .pet-container {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto 16px;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .pet-container:active {
      transform: scale(0.95);
    }
    
    .blob {
      width: 100%;
      height: 100%;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      position: relative;
      animation: blobFloat 3s ease-in-out infinite;
      transition: all 0.3s;
    }
    
    .blob.happy {
      animation: blobBounce 0.5s ease-in-out;
    }
    
    /* Evolution stages affect size and shape */
    .blob.stage-1 { transform: scale(0.5); border-radius: 50%; }
    .blob.stage-2 { transform: scale(0.65); }
    .blob.stage-3 { transform: scale(0.8); }
    .blob.stage-4 { transform: scale(0.9); }
    .blob.stage-5 { transform: scale(1.0); border-radius: 45% 55% 50% 50% / 55% 55% 45% 45%; }
    .blob.stage-6 { 
      transform: scale(1.1); 
      border-radius: 40% 60% 55% 45% / 50% 50% 50% 50%;
      box-shadow: 0 0 40px currentColor;
    }
    
    .blob-face {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      user-select: none;
    }
    
    .blob.stage-5 .blob-face,
    .blob.stage-6 .blob-face { font-size: 40px; }
    
    @keyframes blobFloat {
      0%, 100% { transform: translateY(0) scale(var(--scale, 1)); }
      50% { transform: translateY(-8px) scale(var(--scale, 1)); }
    }
    
    @keyframes blobBounce {
      0%, 100% { transform: scale(var(--scale, 1)); }
      50% { transform: scale(calc(var(--scale, 1) * 1.2)); }
    }
    
    .pet-name {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .pet-level {
      color: #10b981;
      font-size: 14px;
    }
    
    .click-hint {
      color: #52525b;
      font-size: 12px;
      margin-top: 8px;
    }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat {
      background: #18181b;
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 12px;
    }
    .stat-label {
      font-size: 12px;
      color: #71717a;
      margin-bottom: 4px;
    }
    .stat-bar {
      height: 8px;
      background: #27272a;
      border-radius: 4px;
      overflow: hidden;
    }
    .stat-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .stat-fill.hunger { background: #f97316; }
    .stat-fill.happiness { background: #ec4899; }
    .stat-fill.low { background: #ef4444; }
    
    /* Currency */
    .currency {
      background: linear-gradient(135deg, #18181b 0%, #1c1c1f 100%);
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    .coins {
      font-size: 32px;
      font-weight: bold;
      color: #fbbf24;
    }
    .coins-label {
      font-size: 12px;
      color: #71717a;
    }
    .xp-bar {
      margin-top: 12px;
    }
    .xp-label {
      font-size: 12px;
      color: #71717a;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }
    .xp-track {
      height: 6px;
      background: #27272a;
      border-radius: 3px;
      overflow: hidden;
    }
    .xp-fill {
      height: 100%;
      background: #10b981;
      border-radius: 3px;
      transition: width 0.3s;
    }
    
    /* Actions */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .action-btn {
      background: #18181b;
      border: 2px solid #27272a;
      border-radius: 12px;
      padding: 16px 12px;
      color: #fafafa;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .action-btn:hover:not(:disabled) {
      border-color: #10b981;
      background: #10b98110;
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .action-btn .icon {
      font-size: 24px;
    }
    .action-btn .cost {
      font-size: 11px;
      color: #fbbf24;
    }
    
    /* Customize */
    .customize {
      background: #18181b;
      border: 1px solid #27272a;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .customize-label {
      font-size: 12px;
      color: #71717a;
      margin-bottom: 8px;
    }
    .color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.15s;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    .color-option.selected {
      border-color: white;
    }
    
    /* Save indicator */
    .save-status {
      text-align: center;
      font-size: 12px;
      color: #52525b;
      padding: 8px;
    }
    .save-status.saving { color: #fbbf24; }
    .save-status.saved { color: #10b981; }
    
    /* Floating coins animation */
    .floating-coin {
      position: fixed;
      pointer-events: none;
      font-size: 20px;
      animation: floatUp 1s ease-out forwards;
      z-index: 100;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-60px); }
    }
    
    /* Evolution popup */
    .evolution-popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .evolution-popup.show {
      display: flex;
      animation: fadeIn 0.3s;
    }
    .evolution-content {
      background: #18181b;
      border: 2px solid #10b981;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      animation: scaleIn 0.3s;
    }
    .evolution-content h2 {
      color: #10b981;
      margin-bottom: 16px;
    }
    .evolution-content .new-stage {
      font-size: 64px;
      margin: 16px 0;
    }
    .evolution-content button {
      background: #10b981;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    /* Powered by */
    .powered-by {
      margin-top: 24px;
      text-align: center;
      font-size: 12px;
      color: #52525b;
    }
    .powered-by a {
      color: #10b981;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ü´ß Blob Pet</h1>
      <p class="subtitle">Raise your blob ‚Ä¢ Powered by Watchtower</p>
    </header>
    
    <div class="pet-area">
      <div class="pet-container" id="pet" onclick="clickPet()">
        <div class="blob stage-1" id="blob">
          <span class="blob-face" id="face">üòä</span>
        </div>
      </div>
      <div class="pet-name" id="pet-name">Blobby</div>
      <div class="pet-level" id="pet-level">Stage 1 ‚Ä¢ Level 1</div>
      <div class="click-hint">Tap blob for coins!</div>
    </div>
    
    <div class="stats">
      <div class="stat">
        <div class="stat-label">üçé Hunger</div>
        <div class="stat-bar">
          <div class="stat-fill hunger" id="hunger-bar" style="width: 100%"></div>
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">üíñ Happiness</div>
        <div class="stat-bar">
          <div class="stat-fill happiness" id="happiness-bar" style="width: 100%"></div>
        </div>
      </div>
    </div>
    
    <div class="currency">
      <div class="coins" id="coins">0</div>
      <div class="coins-label">coins</div>
      <div class="xp-bar">
        <div class="xp-label">
          <span>XP</span>
          <span id="xp-text">0 / 100</span>
        </div>
        <div class="xp-track">
          <div class="xp-fill" id="xp-bar" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <div class="actions">
      <button class="action-btn" onclick="feed()" id="feed-btn">
        <span class="icon">üçé</span>
        <span>Feed</span>
        <span class="cost">10 coins</span>
      </button>
      <button class="action-btn" onclick="play()" id="play-btn">
        <span class="icon">üéæ</span>
        <span>Play</span>
        <span class="cost">15 coins</span>
      </button>
      <button class="action-btn" onclick="treat()" id="treat-btn">
        <span class="icon">üç∞</span>
        <span>Treat</span>
        <span class="cost">25 coins</span>
      </button>
      <button class="action-btn" onclick="sparkle()" id="sparkle-btn">
        <span class="icon">‚ú®</span>
        <span>Sparkle</span>
        <span class="cost">50 coins</span>
      </button>
    </div>
    
    <div class="customize">
      <div class="customize-label">Blob Color</div>
      <div class="color-picker" id="color-picker"></div>
    </div>
    
    <div class="save-status" id="save-status">Connecting...</div>
    
    <div class="powered-by">
      Cloud saves by <a href="https://watchtower.host" target="_blank">Watchtower</a>
    </div>
  </div>
  
  <div class="evolution-popup" id="evolution-popup">
    <div class="evolution-content">
      <h2>‚ú® EVOLUTION! ‚ú®</h2>
      <div>Your blob evolved to</div>
      <div class="new-stage" id="new-stage-emoji">ü´ß</div>
      <div id="new-stage-name">Stage 2</div>
      <button onclick="closeEvolution()">Awesome!</button>
    </div>
  </div>

  <script type="module">
    import { connect } from 'https://esm.sh/@watchtower-sdk/core@0.5.0'

    // Colors
    const COLORS = [
      '#10b981', // emerald (default)
      '#3b82f6', // blue
      '#8b5cf6', // purple
      '#ec4899', // pink
      '#f97316', // orange
      '#eab308', // yellow
      '#ef4444', // red
      '#06b6d4', // cyan
    ]
    
    // Evolution stages
    const STAGES = [
      { level: 1, name: 'Tiny Blob', emoji: 'ü´ß', face: 'üòä' },
      { level: 5, name: 'Small Blob', emoji: 'üü¢', face: 'üòÑ' },
      { level: 10, name: 'Blob', emoji: 'üîµ', face: 'üòÅ' },
      { level: 20, name: 'Big Blob', emoji: 'üü£', face: 'ü•∞' },
      { level: 35, name: 'Mega Blob', emoji: '‚≠ê', face: 'üòé' },
      { level: 50, name: 'Ultra Blob', emoji: 'üëë', face: 'ü§©' },
    ]
    
    // Game state
    let state = {
      coins: 0,
      xp: 0,
      level: 1,
      hunger: 100,
      happiness: 100,
      color: COLORS[0],
      lastUpdate: Date.now()
    }
    
    let room = null
    const playerId = localStorage.getItem('blobPetId') || crypto.randomUUID()
    localStorage.setItem('blobPetId', playerId)
    
    // DOM elements
    const blob = document.getElementById('blob')
    const face = document.getElementById('face')
    const coinsEl = document.getElementById('coins')
    const xpBar = document.getElementById('xp-bar')
    const xpText = document.getElementById('xp-text')
    const hungerBar = document.getElementById('hunger-bar')
    const happinessBar = document.getElementById('happiness-bar')
    const petLevel = document.getElementById('pet-level')
    const saveStatus = document.getElementById('save-status')
    const colorPicker = document.getElementById('color-picker')
    
    // Initialize
    async function init() {
      setupColorPicker()
      
      try {
        room = await connect('blob-pet-saves', {
          name: 'player',
          gameId: 'blob-pet'
        })
        
        // Try to load saved state
        const saved = await room.load('pet')
        if (saved) {
          state = { ...state, ...saved }
          // Calculate stat decay since last play
          const elapsed = (Date.now() - state.lastUpdate) / 1000 / 60 // minutes
          state.hunger = Math.max(0, state.hunger - elapsed * 0.5)
          state.happiness = Math.max(0, state.happiness - elapsed * 0.3)
        }
        
        updateUI()
        showSaveStatus('saved', 'Pet loaded!')
        
        // Auto-save every 30 seconds
        setInterval(saveGame, 30000)
        
        // Decay stats over time
        setInterval(() => {
          state.hunger = Math.max(0, state.hunger - 0.1)
          state.happiness = Math.max(0, state.happiness - 0.05)
          state.lastUpdate = Date.now()
          updateUI()
        }, 1000)
        
      } catch (e) {
        console.error('Failed to connect:', e)
        showSaveStatus('error', 'Offline mode')
      }
    }
    
    function setupColorPicker() {
      colorPicker.innerHTML = COLORS.map(c => `
        <div class="color-option ${c === state.color ? 'selected' : ''}" 
             style="background: ${c}" 
             data-color="${c}"
             onclick="selectColor('${c}')"></div>
      `).join('')
    }
    
    window.selectColor = (color) => {
      state.color = color
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === color)
      })
      updateUI()
      saveGame()
    }
    
    function updateUI() {
      // Update blob appearance
      const stage = getStage()
      blob.className = `blob stage-${stage}`
      blob.style.background = state.color
      blob.style.setProperty('--scale', [0.5, 0.65, 0.8, 0.9, 1.0, 1.1][stage - 1])
      
      // Face based on stats
      if (state.hunger < 20 || state.happiness < 20) {
        face.textContent = 'üò¢'
      } else if (state.hunger < 50 || state.happiness < 50) {
        face.textContent = 'üòê'
      } else {
        face.textContent = STAGES[stage - 1].face
      }
      
      // Stats
      coinsEl.textContent = Math.floor(state.coins)
      
      const xpNeeded = getXpNeeded()
      const xpProgress = (state.xp / xpNeeded) * 100
      xpBar.style.width = xpProgress + '%'
      xpText.textContent = `${Math.floor(state.xp)} / ${xpNeeded}`
      
      hungerBar.style.width = state.hunger + '%'
      hungerBar.classList.toggle('low', state.hunger < 30)
      
      happinessBar.style.width = state.happiness + '%'
      happinessBar.classList.toggle('low', state.happiness < 30)
      
      petLevel.textContent = `${STAGES[stage - 1].name} ‚Ä¢ Level ${state.level}`
      
      // Button states
      document.getElementById('feed-btn').disabled = state.coins < 10
      document.getElementById('play-btn').disabled = state.coins < 15
      document.getElementById('treat-btn').disabled = state.coins < 25
      document.getElementById('sparkle-btn').disabled = state.coins < 50
    }
    
    function getStage() {
      for (let i = STAGES.length - 1; i >= 0; i--) {
        if (state.level >= STAGES[i].level) return i + 1
      }
      return 1
    }
    
    function getXpNeeded() {
      return Math.floor(100 * Math.pow(1.2, state.level - 1))
    }
    
    function addXp(amount) {
      // Bonus XP for high stats
      const bonus = (state.hunger > 80 && state.happiness > 80) ? 1.5 : 1
      state.xp += amount * bonus
      
      const xpNeeded = getXpNeeded()
      const oldStage = getStage()
      
      while (state.xp >= xpNeeded) {
        state.xp -= xpNeeded
        state.level++
        
        const newStage = getStage()
        if (newStage > oldStage) {
          showEvolution(newStage)
        }
      }
    }
    
    function showEvolution(stage) {
      const stageInfo = STAGES[stage - 1]
      document.getElementById('new-stage-emoji').textContent = stageInfo.emoji
      document.getElementById('new-stage-name').textContent = stageInfo.name
      document.getElementById('evolution-popup').classList.add('show')
    }
    
    window.closeEvolution = () => {
      document.getElementById('evolution-popup').classList.remove('show')
    }
    
    window.clickPet = () => {
      // Coins based on level and stats
      const base = 1 + Math.floor(state.level / 5)
      const bonus = (state.hunger > 50 && state.happiness > 50) ? 2 : 1
      const earned = base * bonus
      
      state.coins += earned
      addXp(1)
      
      // Visual feedback
      blob.classList.add('happy')
      setTimeout(() => blob.classList.remove('happy'), 500)
      
      // Floating coin
      showFloatingCoin(earned)
      
      updateUI()
    }
    
    function showFloatingCoin(amount) {
      const coin = document.createElement('div')
      coin.className = 'floating-coin'
      coin.textContent = `+${amount} ü™ô`
      coin.style.left = (Math.random() * 100 + 150) + 'px'
      coin.style.top = (Math.random() * 50 + 150) + 'px'
      document.body.appendChild(coin)
      setTimeout(() => coin.remove(), 1000)
    }
    
    window.feed = () => {
      if (state.coins < 10) return
      state.coins -= 10
      state.hunger = Math.min(100, state.hunger + 30)
      addXp(5)
      blobReact()
      updateUI()
      saveGame()
    }
    
    window.play = () => {
      if (state.coins < 15) return
      state.coins -= 15
      state.happiness = Math.min(100, state.happiness + 25)
      state.hunger = Math.max(0, state.hunger - 5) // Playing makes hungry
      addXp(8)
      blobReact()
      updateUI()
      saveGame()
    }
    
    window.treat = () => {
      if (state.coins < 25) return
      state.coins -= 25
      state.hunger = Math.min(100, state.hunger + 15)
      state.happiness = Math.min(100, state.happiness + 20)
      addXp(12)
      blobReact()
      updateUI()
      saveGame()
    }
    
    window.sparkle = () => {
      if (state.coins < 50) return
      state.coins -= 50
      state.happiness = Math.min(100, state.happiness + 40)
      addXp(25)
      blobReact()
      
      // Extra sparkle effect
      blob.style.boxShadow = `0 0 60px ${state.color}`
      setTimeout(() => {
        blob.style.boxShadow = getStage() === 6 ? `0 0 40px ${state.color}` : 'none'
      }, 1000)
      
      updateUI()
      saveGame()
    }
    
    function blobReact() {
      blob.classList.add('happy')
      setTimeout(() => blob.classList.remove('happy'), 500)
    }
    
    async function saveGame() {
      if (!room) return
      
      showSaveStatus('saving', 'Saving...')
      try {
        state.lastUpdate = Date.now()
        await room.save('pet', state)
        showSaveStatus('saved', 'Saved ‚úì')
      } catch (e) {
        showSaveStatus('error', 'Save failed')
      }
    }
    
    function showSaveStatus(type, text) {
      saveStatus.className = 'save-status ' + type
      saveStatus.textContent = text
      
      if (type === 'saved') {
        setTimeout(() => {
          saveStatus.textContent = 'Auto-saving enabled'
          saveStatus.className = 'save-status'
        }, 2000)
      }
    }
    
    // Start
    init()
  </script>
</body>
</html>
